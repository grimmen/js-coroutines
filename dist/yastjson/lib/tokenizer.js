"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.Tokenizer=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_token=require("./token"),_yielder=require("./yielder"),INVISIBLE_CHAR_CODE_TOKEN_LIST=[10,13,32],STATE_INIT="init",STATE_KW_NULL="null",STATE_KW_TRUE="boolean_true",STATE_KW_FALSE="boolean_false",STATE_NUMBER="number",STATE_STRING="string",STATE_STRING_ESCAPE="escape",INITIAL_STATE={"[":_token.TokenType.LeftBracket,"]":_token.TokenType.RightBracket,"{":_token.TokenType.LeftBrace,"}":_token.TokenType.RightBrace,":":_token.TokenType.Colon,",":_token.TokenType.Comma},MOVE_TO={"[":STATE_INIT,"]":STATE_INIT,"{":STATE_INIT,"}":STATE_INIT,":":STATE_INIT,",":STATE_INIT,n:STATE_KW_NULL,t:STATE_KW_TRUE,f:STATE_KW_FALSE,0:STATE_NUMBER,1:STATE_NUMBER,2:STATE_NUMBER,3:STATE_NUMBER,4:STATE_NUMBER,5:STATE_NUMBER,6:STATE_NUMBER,7:STATE_NUMBER,8:STATE_NUMBER,9:STATE_NUMBER,"-":STATE_NUMBER,'"':STATE_STRING},Tokenizer=function(){function Tokenizer(){(0,_classCallCheck2.default)(this,Tokenizer),this.state=STATE_INIT,this.pos=0,this.sourceCode="",this.tokens=[],this.curToken=""}return(0,_createClass2.default)(Tokenizer,[{key:"tokenizeArray",value:_regenerator.default.mark(function tokenizeArray(src){var length,text;return _regenerator.default.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:this.sourceCode=src,this.type="uint8",length=src.length;case 3:if(!(this.pos<length)){_context.next=28;break}if(!(0==(15&this.pos)&&(0,_yielder.yielder)())){_context.next=7;break}return void(_context.next=7);case 7:text=this.readCharacter(),_context.t0=this.state,_context.next=_context.t0===STATE_INIT?11:_context.t0===STATE_KW_NULL?13:_context.t0===STATE_KW_TRUE?15:_context.t0===STATE_KW_FALSE?17:_context.t0===STATE_NUMBER?19:_context.t0===STATE_STRING?21:_context.t0===STATE_STRING_ESCAPE?23:25;break;case 11:return this.initToken(text),_context.abrupt("break",26);case 13:return this.handleTokenNull(text),_context.abrupt("break",26);case 15:return this.handleTokenTrue(text),_context.abrupt("break",26);case 17:return this.handleTokenFalse(text),_context.abrupt("break",26);case 19:return this.handleTokenNumber(text),_context.abrupt("break",26);case 21:return this.handleTokenString(text),_context.abrupt("break",26);case 23:return this.handleTokenStringEscape(text),_context.abrupt("break",26);case 25:throw new Error("finite state machine get an unexpected state: ".concat(this.state));case 26:_context.next=3;break;case 28:return _context.abrupt("return",this.tokens);case 29:case"end":return _context.stop();}},tokenizeArray,this)})},{key:"tokenize",value:_regenerator.default.mark(function tokenize(src){var length,text;return _regenerator.default.wrap(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(!(src instanceof Uint8Array)){_context2.next=3;break}return _context2.delegateYield(this.tokenizeArray(src),"t0",2);case 2:return _context2.abrupt("return",_context2.t0);case 3:this.type="char",this.sourceCode=src,length=src.length;case 6:if(!(this.pos<length)){_context2.next=31;break}if(!(0==(7&this.pos)&&(0,_yielder.yielder)())){_context2.next=10;break}return void(_context2.next=10);case 10:text=this.read(),_context2.t1=this.state,_context2.next=_context2.t1===STATE_INIT?14:_context2.t1===STATE_KW_NULL?16:_context2.t1===STATE_KW_TRUE?18:_context2.t1===STATE_KW_FALSE?20:_context2.t1===STATE_NUMBER?22:_context2.t1===STATE_STRING?24:_context2.t1===STATE_STRING_ESCAPE?26:28;break;case 14:return this.initToken(text),_context2.abrupt("break",29);case 16:return this.handleTokenNull(text),_context2.abrupt("break",29);case 18:return this.handleTokenTrue(text),_context2.abrupt("break",29);case 20:return this.handleTokenFalse(text),_context2.abrupt("break",29);case 22:return this.handleTokenNumber(text),_context2.abrupt("break",29);case 24:return this.handleTokenString(text),_context2.abrupt("break",29);case 26:return this.handleTokenStringEscape(text),_context2.abrupt("break",29);case 28:throw new Error("finite state machine get an unexpected state: ".concat(this.state));case 29:_context2.next=6;break;case 31:return _context2.abrupt("return",this.tokens);case 32:case"end":return _context2.stop();}},tokenize,this)})},{key:"read",value:function read(){var code;do code=this.sourceCode[this.pos++];while(code&&32>code.charCodeAt(0));return code}},{key:"readCharacter",value:function readCharacter(){var c=this.sourceCode[this.pos++];switch(c>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:return String.fromCharCode(c);case 12:case 13:return String.fromCharCode((31&c)<<6|63&this.sourceCode[this.pos++]);case 14:return String.fromCharCode((15&c)<<12|(63&this.sourceCode[this.pos++])<<6|63&this.sourceCode[this.pos++]);default:throw new Error("Bad encoding");}}},{key:"peek",value:function peek(){if("char"===this.type){for(var offset=this.pos;this.sourceCode[offset]&&32>this.sourceCode[offset].charCodeAt(0);)offset++;return this.sourceCode[offset]}for(var read=function(){var c=code[_offset++];switch(c>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:return String.fromCharCode(c);case 12:case 13:return String.fromCharCode((31&c)<<6|63&code[_offset++]);case 14:return String.fromCharCode((15&c)<<12|(63&code[_offset++])<<6|63&code[_offset++]);default:throw new Error("Bad encoding");}},_offset=this.pos,code=this.sourceCode,value=read();32>value.charCodeAt(0)&&_offset<code.length;)value=read();return 0===value.charCodeAt(0)?void 0:value}},{key:"initToken",value:function initToken(ch){for(;ch&&32>=ch.charCodeAt(0);)ch=this.sourceCode[this.pos++];var type=INITIAL_STATE[ch];if(!type&&!INVISIBLE_CHAR_CODE_TOKEN_LIST.includes(ch.charCodeAt(0)))throw new Error("state INIT, unexpected token ".concat(ch));for(this.tokens.push({text:ch,type:type});" "===this.peek();)this.pos++;var nextCh=this.peek();if(void 0!==nextCh&&(this.state=MOVE_TO[nextCh],!this.state))throw new Error("Unexpected character [".concat(type,":").concat(nextCh.charCodeAt(0),"] '").concat(ch,"' @ ").concat(this.pos," - ").concat(this.sourceCode.slice(Math.max(0,this.pos-16),this.pos+16)))}},{key:"handleTokenNull",value:function handleTokenNull(ch){switch(ch){case"n":case"u":this.curToken+=ch;break;case"l":if(this.curToken+=ch,"null"===this.curToken){var token={text:this.curToken,type:_token.TokenType.Null};this.tokens.push(token),this.curToken="",this.state=STATE_INIT}else if("nul"===this.curToken);else throw new Error("state NULL, unexpected token ".concat(ch));break;default:throw new Error("state NULL, unexpected token ".concat(ch));}}},{key:"handleTokenTrue",value:function handleTokenTrue(ch){switch(ch){case"t":case"r":case"u":this.curToken+=ch;break;case"e":if("tru"!==this.curToken)throw new Error("state TRUE, unexpected token ".concat(ch));this.curToken+=ch;var token={text:this.curToken,type:_token.TokenType.Boolean};this.tokens.push(token),this.curToken="",this.state=STATE_INIT;break;default:throw new Error("state TRUE, unexpected token ".concat(ch));}}},{key:"handleTokenFalse",value:function handleTokenFalse(ch){switch(ch){case"f":case"a":case"l":case"s":this.curToken+=ch;break;case"e":this.curToken+=ch;var token={text:this.curToken,type:_token.TokenType.Boolean};this.tokens.push(token),this.curToken="",this.state=STATE_INIT;break;default:throw new Error("state FALSE, unexpected token ".concat(ch));}}},{key:"handleTokenNumber",value:function handleTokenNumber(ch){switch(ch){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":if(this.curToken+=ch,!/[0-9]|\.|-/.test(this.peek())){var token={text:this.curToken,type:_token.TokenType.Number};this.tokens.push(token),this.curToken="",this.state=STATE_INIT}break;case"-":case".":this.curToken+=ch;break;default:throw new Error("state NUMBER, unexpected token ".concat(ch));}}},{key:"handleTokenStringEscape",value:function handleTokenStringEscape(ch){return"u"===ch?(this.curToken+=JSON.parse("\"\\u".concat(this.read()).concat(this.read()).concat(this.read()).concat(this.read(),"\"")),void(this.state=STATE_STRING)):void(this.curToken+=JSON.parse("\"\\".concat(ch,"\"")),this.state=STATE_STRING)}},{key:"handleTokenString",value:function handleTokenString(ch){switch(ch){case"\\":this.state=STATE_STRING_ESCAPE;break;case"\"":if(""===this.curToken)this.curToken=ch;else{this.curToken+=ch;var token={text:this.curToken,type:_token.TokenType.String};this.tokens.push(token),this.curToken="",this.state=STATE_INIT}break;default:this.curToken+=ch;}}}]),Tokenizer}();exports.Tokenizer=Tokenizer;