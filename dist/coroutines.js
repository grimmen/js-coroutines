"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.useInternalEngine=useInternalEngine,exports.run=run,exports.update=update,exports.pipe=pipe,exports.compose=compose,exports.tap=tap,exports.branch=branch,exports.call=call,exports.repeat=repeat,exports.singleton=singleton,exports.default=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_polyfill=require("./polyfill");function _createForOfIteratorHelper(o,allowArrayLike){var it;if("undefined"==typeof Symbol||null==o[Symbol.iterator]){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function n(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function e(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function s(){it=o[Symbol.iterator]()},n:function n(){var step=it.next();return normalCompletion=step.done,step},e:function e(_e2){didErr=!0,err=_e2},f:function f(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var request="undefined"==typeof window?(0,_polyfill.getNodeCallback)():window.requestIdleCallback,performance="undefined"!=typeof window&&window.performance?window.performance:{now:function now(){return Date.now()}};function useInternalEngine(internal){request=internal?(0,_polyfill.getCallback)():request}function run(coroutine){var loopWhileMsRemains=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,timeout=2<arguments.length&&void 0!==arguments[2]?arguments[2]:320,terminated=!1,resolver=null,result=new Promise(function(resolve,reject){function run(){return _run.apply(this,arguments)}function _run(){return _run=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee(api){var minTime,_iterator$next,value,done;return _regenerator.default.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(clearTimeout(id),!terminated){_context.next=4;break}return iterator.return(),_context.abrupt("return");case 4:minTime=Math.max(.5,loopWhileMsRemains),_context.prev=5;case 6:return _context.t0=iterator,_context.next=9,parameter;case 9:if(_context.t1=_context.sent,_iterator$next=_context.t0.next.call(_context.t0,_context.t1),value=_iterator$next.value,done=_iterator$next.done,parameter=void 0,!done){_context.next=17;break}return resolve(value),_context.abrupt("return");case 17:if(!0!==value){_context.next=21;break}return _context.abrupt("break",23);case 21:"number"==typeof value?(minTime=+value,isNaN(minTime)&&(minTime=1)):value&&value.then&&(parameter=value);case 22:if(api.timeRemaining()>minTime){_context.next=6;break}case 23:_context.next=30;break;case 25:return _context.prev=25,_context.t2=_context["catch"](5),console.error(_context.t2),reject(_context.t2),_context.abrupt("return");case 30:request(run),id=setTimeout(runFromTimeout,timeout);case 32:case"end":return _context.stop();}},_callee,null,[[5,25]])})),_run.apply(this,arguments)}function runFromTimeout(){var start=performance.now();run({timeRemaining:function timeRemaining(){return 8.5-(performance.now()-start)}})}resolver=resolve;var iterator=coroutine.next?coroutine:coroutine();request(run);var id=setTimeout(runFromTimeout,timeout),parameter=void 0});return result.terminate=function(result){terminated=!0,resolver&&resolver(result)},result}var requested=!1,animationCallbacks=[];function nextAnimationFrame(fn){if("undefined"==typeof window)throw new Error("Cannot run without a browser");0!==animationCallbacks.length||requested||(requested=!0,requestAnimationFrame(process)),animationCallbacks.push(fn),1e4<animationCallbacks.length&&(animationCallbacks=animationCallbacks.slice(-9e3))}function process(){var callbacks=animationCallbacks;callbacks.length?requestAnimationFrame(process):requested=!1,animationCallbacks=[];var _step,_iterator=_createForOfIteratorHelper(callbacks);try{for(_iterator.s();!(_step=_iterator.n()).done;){var callback=_step.value;callback()}}catch(err){_iterator.e(err)}finally{_iterator.f()}}function update(coroutine){for(var _len=arguments.length,params=Array(1<_len?_len-1:0),_key=1;_key<_len;_key++)params[_key-1]=arguments[_key];if("undefined"==typeof window)throw new Error("Requires a browser to run");var terminated=!1,resolver=null,result=new Promise(function(resolve,reject){function run(){if(terminated)return void iterator.return();try{var _iterator$next2=iterator.next(),value=_iterator$next2.value,done=_iterator$next2.done;if(done)return void resolve(value)}catch(e){return void reject(e)}nextAnimationFrame(run)}resolver=resolve;var iterator=coroutine.next?coroutine:coroutine.apply(void 0,params);nextAnimationFrame(run)});return result.terminate=function(result){terminated=!0,resolver&&resolver(result)},result}function pipe(){for(var _len2=arguments.length,fns=Array(_len2),_key2=0;_key2<_len2;_key2++)fns[_key2]=arguments[_key2];return function(){var _ref=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee2(params){var result,_iterator2,_step2,fn,nextResult;return _regenerator.default.wrap(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:result=params,_iterator2=_createForOfIteratorHelper(fns.flat(1/0)),_context2.prev=2,_iterator2.s();case 4:if((_step2=_iterator2.n()).done){_context2.next=25;break}if(fn=_step2.value,fn){_context2.next=8;break}return _context2.abrupt("continue",23);case 8:if(nextResult=fn.call(this,result),!nextResult){_context2.next=23;break}if(!nextResult.next){_context2.next=16;break}return _context2.next=13,run(nextResult);case 13:result=_context2.sent,_context2.next=23;break;case 16:if(!nextResult.then){_context2.next=22;break}return _context2.next=19,nextResult;case 19:result=_context2.sent,_context2.next=23;break;case 22:result=nextResult;case 23:_context2.next=4;break;case 25:_context2.next=30;break;case 27:_context2.prev=27,_context2.t0=_context2["catch"](2),_iterator2.e(_context2.t0);case 30:return _context2.prev=30,_iterator2.f(),_context2.finish(30);case 33:return _context2.abrupt("return",result);case 34:case"end":return _context2.stop();}},_callee2,this,[[2,27,30,33]])}));return function(){return _ref.apply(this,arguments)}}()}function compose(){for(var _len3=arguments.length,fns=Array(_len3),_key3=0;_key3<_len3;_key3++)fns[_key3]=arguments[_key3];return function(){var _ref2=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee3(params){var result,list,i,fn,nextResult;return _regenerator.default.wrap(function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:result=params,list=fns.flat(1/0),i=list.length-1;case 3:if(!(0<=i)){_context3.next=25;break}if(fn=list[i],fn){_context3.next=7;break}return _context3.abrupt("continue",22);case 7:if(nextResult=fn.call(this,result),!nextResult){_context3.next=22;break}if(!nextResult.next){_context3.next=15;break}return _context3.next=12,run(nextResult);case 12:result=_context3.sent,_context3.next=22;break;case 15:if(!nextResult.then){_context3.next=21;break}return _context3.next=18,nextResult;case 18:result=_context3.sent,_context3.next=22;break;case 21:result=nextResult;case 22:i--,_context3.next=3;break;case 25:return _context3.abrupt("return",result);case 26:case"end":return _context3.stop();}},_callee3,this)}));return function(){return _ref2.apply(this,arguments)}}()}function tap(fn){return function(){var _ref3=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee4(params){var result;return _regenerator.default.wrap(function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:if(result=fn.call(this,params),!result){_context4.next=10;break}if(!result.next){_context4.next=7;break}return _context4.next=5,run(result);case 5:_context4.next=10;break;case 7:if(!result.then){_context4.next=10;break}return _context4.next=10,result;case 10:return _context4.abrupt("return",params);case 11:case"end":return _context4.stop();}},_callee4,this)}));return function(){return _ref3.apply(this,arguments)}}()}function branch(fn){return function(params){var result=fn.call(this,params);return result&&(result.next?run(result).catch(console.error):result.then&&result.catch(console.error)),params}}function call(fn){for(var _len4=arguments.length,config=Array(1<_len4?_len4-1:0),_key4=1;_key4<_len4;_key4++)config[_key4-1]=arguments[_key4];return function(){for(var _len5=arguments.length,params=Array(_len5),_key5=0;_key5<_len5;_key5++)params[_key5]=arguments[_key5];return fn.apply(this,[].concat(params,config))}}function repeat(fn,times){return function(){var _ref4=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee5(params){var result,i;return _regenerator.default.wrap(function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:result=params,i=0;case 2:if(!(i<times)){_context5.next=17;break}if(result=fn.call(this,result),!result.next){_context5.next=10;break}return _context5.next=7,run(result);case 7:result=_context5.sent,_context5.next=14;break;case 10:if(!result.then){_context5.next=14;break}return _context5.next=13,result;case 13:result=_context5.sent;case 14:i++,_context5.next=2;break;case 17:return _context5.abrupt("return",result);case 18:case"end":return _context5.stop();}},_callee5,this)}));return function(){return _ref4.apply(this,arguments)}}()}var _default=run;exports.default=_default;function singleton(fn,defaultValue){var promise=null,extraPromises=[],result=function(){return promise&&(extraPromises.forEach(function(p){return p.terminate()}),extraPromises=[],promise.terminate(defaultValue)),promise=result._promise=run(fn.apply(void 0,arguments))};return result.join=function(promise){return extraPromises.push(promise),promise},result}