"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.useInternalEngine=useInternalEngine,exports.run=run,exports.update=update,exports.pipe=pipe,exports.compose=compose,exports.tap=tap,exports.branch=branch,exports.call=call,exports.repeat=repeat,exports.singleton=singleton,exports.default=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_polyfill=require("./polyfill");function _createForOfIteratorHelper(o,a){var b;if("undefined"==typeof Symbol||null==o[Symbol.iterator]){if(Array.isArray(o)||(b=_unsupportedIterableToArray(o))||a&&o&&"number"==typeof o.length){b&&(o=b);var c=0,d=function(){};return{s:d,n:function n(){return c>=o.length?{done:!0}:{done:!1,value:o[c++]}},e:function e(a){throw a},f:d}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var e,f=!0,g=!1;return{s:function s(){b=o[Symbol.iterator]()},n:function n(){var a=b.next();return f=a.done,a},e:function e(a){g=!0,e=a},f:function f(){try{f||null==b.return||b.return()}finally{if(g)throw e}}}}function _unsupportedIterableToArray(o,a){if(o){if("string"==typeof o)return _arrayLikeToArray(o,a);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,a):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}var request="undefined"==typeof window?(0,_polyfill.getNodeCallback)():window.requestIdleCallback,performance="undefined"!=typeof window&&window.performance?window.performance:{now:function now(){return Date.now()}};function useInternalEngine(a){request=a?(0,_polyfill.getCallback)():request}function run(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:960,d=!1,e=null,f=new Promise(function(f,g){function h(){return i.apply(this,arguments)}function i(){return i=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(e){var i,n,o,p;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(clearTimeout(l),!d){a.next=4;break}return k.return(),a.abrupt("return");case 4:i=Math.max(.5,b),a.prev=5;case 6:return a.t0=k,a.next=9,m;case 9:if(a.t1=a.sent,n=a.t0.next.call(a.t0,a.t1),o=n.value,p=n.done,m=void 0,!p){a.next=17;break}return f(o),a.abrupt("return");case 17:if(!0!==o){a.next=21;break}return a.abrupt("break",23);case 21:"number"==typeof o?(i=+o,isNaN(i)&&(i=1)):o&&o.then&&(m=o);case 22:if(e.timeRemaining()>i){a.next=6;break}case 23:a.next=30;break;case 25:return a.prev=25,a.t2=a["catch"](5),console.error(a.t2),g(a.t2),a.abrupt("return");case 30:e.timeout||request(h),l=setTimeout(j,c);case 32:case"end":return a.stop();}},a,null,[[5,25]])})),i.apply(this,arguments)}function j(){var a=Date.now();h({timeout:!0,timeRemaining:function timeRemaining(){return 12.5-(Date.now()-a)}})}e=f;var k=a.next?a:a();request(h);var l=setTimeout(j,c),m=void 0});return f.terminate=function(a){d=!0,e&&e(a)},f}var requested=!1,animationCallbacks=[];function nextAnimationFrame(a){if("undefined"==typeof window)throw new Error("Cannot run without a browser");0!==animationCallbacks.length||requested||(requested=!0,requestAnimationFrame(process)),animationCallbacks.push(a),1e4<animationCallbacks.length&&(animationCallbacks=animationCallbacks.slice(-9e3))}function process(){var a=animationCallbacks;a.length?requestAnimationFrame(process):requested=!1,animationCallbacks=[];var b,c=_createForOfIteratorHelper(a);try{for(c.s();!(b=c.n()).done;){var d=b.value;d()}}catch(a){c.e(a)}finally{c.f()}}function update(a){for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];if("undefined"==typeof window)throw new Error("Requires a browser to run");var e=!1,f=null,g=new Promise(function(b,d){function g(){if(e)return void h.return();try{var a=h.next(),c=a.value,f=a.done;if(f)return void b(c)}catch(a){return void d(a)}nextAnimationFrame(g)}f=b;var h=a.next?a:a.apply(void 0,c);nextAnimationFrame(g)});return g.terminate=function(a){e=!0,f&&f(a)},g}function pipe(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(c){var d,e,f,g,h;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:d=c,e=_createForOfIteratorHelper(b.flat(1/0)),a.prev=2,e.s();case 4:if((f=e.n()).done){a.next=25;break}if(g=f.value,g){a.next=8;break}return a.abrupt("continue",23);case 8:if(h=g.call(this,d),!h){a.next=23;break}if(!h.next){a.next=16;break}return a.next=13,run(h);case 13:d=a.sent,a.next=23;break;case 16:if(!h.then){a.next=22;break}return a.next=19,h;case 19:d=a.sent,a.next=23;break;case 22:d=h;case 23:a.next=4;break;case 25:a.next=30;break;case 27:a.prev=27,a.t0=a["catch"](2),e.e(a.t0);case 30:return a.prev=30,e.f(),a.finish(30);case 33:return a.abrupt("return",d);case 34:case"end":return a.stop();}},a,this,[[2,27,30,33]])}));return function(){return a.apply(this,arguments)}}()}function compose(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(c){var d,e,f,g,h;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:d=c,e=b.flat(1/0),f=e.length-1;case 3:if(!(0<=f)){a.next=25;break}if(g=e[f],g){a.next=7;break}return a.abrupt("continue",22);case 7:if(h=g.call(this,d),!h){a.next=22;break}if(!h.next){a.next=15;break}return a.next=12,run(h);case 12:d=a.sent,a.next=22;break;case 15:if(!h.then){a.next=21;break}return a.next=18,h;case 18:d=a.sent,a.next=22;break;case 21:d=h;case 22:f--,a.next=3;break;case 25:return a.abrupt("return",d);case 26:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()}function tap(a){return function(){var b=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(c){var d;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(d=a.call(this,c),!d){b.next=10;break}if(!d.next){b.next=7;break}return b.next=5,run(d);case 5:b.next=10;break;case 7:if(!d.then){b.next=10;break}return b.next=10,d;case 10:return b.abrupt("return",c);case 11:case"end":return b.stop();}},b,this)}));return function(){return b.apply(this,arguments)}}()}function branch(a){return function(b){var c=a.call(this,b);return c&&(c.next?run(c).catch(console.error):c.then&&c.catch(console.error)),b}}function call(a){for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];return function(){for(var b=arguments.length,d=Array(b),e=0;e<b;e++)d[e]=arguments[e];return a.apply(this,[].concat(d,c))}}function repeat(a,b){return function(){var c=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function c(d){var e,f;return _regenerator.default.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:e=d,f=0;case 2:if(!(f<b)){c.next=17;break}if(e=a.call(this,e),!e.next){c.next=10;break}return c.next=7,run(e);case 7:e=c.sent,c.next=14;break;case 10:if(!e.then){c.next=14;break}return c.next=13,e;case 13:e=c.sent;case 14:f++,c.next=2;break;case 17:return c.abrupt("return",e);case 18:case"end":return c.stop();}},c,this)}));return function(){return c.apply(this,arguments)}}()}var _default=run;exports.default=_default;function singleton(a,b){var c=null,d=[],e=function(){return c&&(d.forEach(function(a){return a.terminate()}),d=[],c.terminate(b)),c=e._promise=run(a.apply(void 0,arguments))};return e.join=function(a){return d.push(a),a},e}